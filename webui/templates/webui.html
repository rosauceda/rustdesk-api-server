{% load static %}<!DOCTYPE html>
<html>

<head>

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="Remote Desktop.">

  <!-- iOS meta tags & icons -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="RustDesk">
  <link rel="apple-touch-icon" href="{% static 'web_client/favicon.svg' %}">

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="{% static 'web_client/favicon.svg' %}" />

  <title>RustDesk Web桌面</title>
  <link rel="manifest" href="{% static "/web_client/manifest.json" %}">
  <script src="{% static "/web_client/ogvjs-1.8.6/ogv.js" %}"></script>
  <script>
    (function () {
      var raw = "{{ domain|escapejs }}";
      var normalized = (raw || "").trim().replace(/^https?:\/\//i, "").split("/")[0];
      var isHostPort = /^[^:/\s?#]+(?::\d+)?$/.test(normalized);
      if (!isHostPort) {
        normalized = window.location.hostname;
      }

      function looksInvalid(v) {
        if (!v) return true;
        var value = String(v).trim();
        if (!value) return true;
        if (/^https?:\/\//i.test(value)) return true;
        if (value.indexOf("/") >= 0) return true;
        return !/^[^:/\s?#]+(?::\d+)?$/.test(value);
      }

      var current = localStorage.getItem("rendezvous-server");
      if (looksInvalid(current)) {
        localStorage.setItem("rendezvous-server", normalized);
      }

      var custom = localStorage.getItem("custom-rendezvous-server");
      if (looksInvalid(custom)) {
        localStorage.removeItem("custom-rendezvous-server");
      }

      window.api = [normalized];
      window.__rustdeskUsePathProxy = false;
      window.__rustdeskModuleLoaded = false;

      function loadRustdeskModule() {
        if (window.__rustdeskModuleLoaded) {
          return;
        }
        window.__rustdeskModuleLoaded = true;
        var mod = document.createElement('script');
        mod.type = 'module';
        mod.crossOrigin = 'anonymous';
        mod.src = '{% static "/web_client/module/index.b7bb6fa2.js" %}';
        document.head.appendChild(mod);
      }

      // Force websocket over 443 path when external high ports are blocked.
      var NativeWebSocket = window.WebSocket;
      if (typeof NativeWebSocket === "function") {
        function rewriteWsUrl(url) {
          if (!window.__rustdeskUsePathProxy) {
            return url;
          }
          try {
            var u = new URL(url, window.location.href);
            if (u.hostname !== window.location.hostname) {
              return url;
            }
            if (u.port === "21118") {
              u.port = "";
              u.pathname = "/ws/id";
              u.search = "";
              u.hash = "";
              return u.toString();
            }
            if (u.port === "21119") {
              u.port = "";
              u.pathname = "/ws/relay";
              u.search = "";
              u.hash = "";
              return u.toString();
            }
          } catch (e) {
            return url;
          }
          return url;
        }

        function PatchedWebSocket(url, protocols) {
          var rewrittenUrl = rewriteWsUrl(String(url));
          return protocols !== undefined
            ? new NativeWebSocket(rewrittenUrl, protocols)
            : new NativeWebSocket(rewrittenUrl);
        }

        PatchedWebSocket.prototype = NativeWebSocket.prototype;
        Object.setPrototypeOf(PatchedWebSocket, NativeWebSocket);
        ["CONNECTING", "OPEN", "CLOSING", "CLOSED"].forEach(function (k) {
          PatchedWebSocket[k] = NativeWebSocket[k];
        });
        window.WebSocket = PatchedWebSocket;
      }

      // Auto-detect if nginx path proxy is enabled.
      // If /ws/id is not routed (404), keep direct :21118/:21119 mode.
      var settled = false;
      function finishDetection(usePathProxy) {
        if (settled) {
          return;
        }
        settled = true;
        window.__rustdeskUsePathProxy = !!usePathProxy;
        loadRustdeskModule();
      }

      var detectionTimer = setTimeout(function () {
        finishDetection(false);
      }, 1500);

      fetch('/ws/id', { method: 'GET', cache: 'no-store' })
        .then(function (resp) {
          clearTimeout(detectionTimer);
          finishDetection(resp.status !== 404);
        })
        .catch(function () {
          clearTimeout(detectionTimer);
          finishDetection(false);
        });
    })();
  </script>
  
  <script src="{% static "/web_client/js/yuv-canvas-1.2.6.js" %}"></script>
  <style>
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0;
      position: absolute;
      top: 50%;
      left: 50%;
      -ms-transform: translate(-50%, -50%);
      transform: translate(-50%, -50%);
    }

    .loader {
      border: 16px solid #f3f3f3;
      border-radius: 50%;
      border: 15px solid;
      border-top: 16px solid #024eff;
      border-right: 16px solid white;
      border-bottom: 16px solid #024eff;
      border-left: 16px solid white;
      width: 120px;
      height: 120px;
      -webkit-animation: spin 2s linear infinite;
      animation: spin 2s linear infinite;
    }

    @-webkit-keyframes spin {
      0% {
        -webkit-transform: rotate(0deg);
      }

      100% {
        -webkit-transform: rotate(360deg);
      }
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>

</head>

<body>
  <div class="loading">
    <div class="loader"></div>
  </div>
  <!-- This script installs service_worker.js to provide PWA functionality to
       application. For more information, see:
       https://developers.google.com/web/fundamentals/primers/service-workers -->
  <script>
    var serviceWorkerVersion = "1";
    var scriptLoaded = false;

    function loadMainDartJs() {
      if (scriptLoaded) {
        return;
      }
      scriptLoaded = true;
      var scriptTag = document.createElement('script');
      scriptTag.src = '{% static "/web_client/js/main.dart.js" %}';
      scriptTag.type = 'application/javascript';
      document.body.append(scriptTag);
    }

    function shouldRegisterServiceWorker(serviceWorkerUrl) {
      return fetch(serviceWorkerUrl, { cache: 'no-store' })
        .then(function (resp) {
          if (!resp.ok) {
            return '';
          }
          return resp.text();
        })
        .then(function (content) {
          if (!content) {
            return false;
          }
          return content.indexOf('$$RESOURCES_MAP') === -1 && content.indexOf('$$CORE_LIST') === -1;
        })
        .catch(function () {
          return false;
        });
    }

    if ('serviceWorker' in navigator) {
      // Service workers are supported. Use them.
      window.addEventListener('load', function () {
        // Wait for registration to finish before dropping the <script> tag.
        // Otherwise, the browser will load the script multiple times,
        // potentially different versions.
        var serviceWorkerUrl = '{% static "/web_client/flutter_service_worker.js" %}?v=' + serviceWorkerVersion;
        shouldRegisterServiceWorker(serviceWorkerUrl).then(function (canRegister) {
          if (!canRegister) {
            console.warn('Skipping invalid service worker, loading app directly.');
            loadMainDartJs();
            return;
          }

          navigator.serviceWorker.register(serviceWorkerUrl)
            .then((reg) => {
              function waitForActivation(serviceWorker) {
                serviceWorker.addEventListener('statechange', () => {
                  if (serviceWorker.state == 'activated') {
                    console.log('Installed new service worker.');
                    loadMainDartJs();
                  }
                });
              }
              if (!reg.active && (reg.installing || reg.waiting)) {
                // No active web worker and we have installed or are installing
                // one for the first time. Simply wait for it to activate.
                waitForActivation(reg.installing || reg.waiting);
              } else if (!reg.active.scriptURL.endsWith(serviceWorkerVersion)) {
                // When the app updates the serviceWorkerVersion changes, so we
                // need to ask the service worker to update.
                console.log('New service worker available.');
                reg.update();
                waitForActivation(reg.installing);
              } else {
                // Existing service worker is still good.
                console.log('Loading app from service worker.');
                loadMainDartJs();
              }
            })
            .catch(function (err) {
              console.warn('Service worker registration failed. Loading app directly.', err);
              loadMainDartJs();
            });
        });

        // If service worker doesn't succeed in a reasonable amount of time,
        // fallback to plaint <script> tag.
        setTimeout(() => {
          if (!scriptLoaded) {
            console.warn(
              'Failed to load app from service worker. Falling back to plain <script> tag.',
            );
            loadMainDartJs();
          }
        }, 4000);
      });
    } else {
      // Service workers not supported. Just drop the <script> tag.
      loadMainDartJs();
    }
  </script>
  <script src="{% static "/web_client/libs/firebase-app.js" %}?8.10.1"></script>

  <script>
    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyCgehIZk1aFP0E7wZtYRRqrfvNiNAF39-A",
      authDomain: "rustdesk.firebaseapp.com",
      databaseURL: "https://rustdesk.firebaseio.com",
      projectId: "rustdesk",
      storageBucket: "rustdesk.appspot.com",
      messagingSenderId: "768133699366",
      appId: "1:768133699366:web:d50faf0792cb208d7993e7",
      measurementId: "G-9PEH85N6ZQ"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    //firebase.analytics();
  </script>
</body>

</html>
